(ns com.lemondronor.droneklv
  "Decode KLV metadata from drone video."
  (:require [clojure.pprint :as pprint]
            [clojure.string :as string]
            [com.lemonodor.xio :as xio]
            [gloss.core :as gloss]
            [gloss.io])
  (:import [com.lemondronor.droneklv KLV KLV$KeyLength KLV$LengthEncoding]
           [java.nio ByteBuffer]
           [java.util Arrays]))

(set! *warn-on-reflection* true)


(defn- ints->bytes
  [ints]
  (mapv #(let [i (int %)]
           (byte
            (cond
              (<= 0 i 127)
              i
              (<= 128 i 255)
              (- i 256)
              :else
              (throw (IllegalArgumentException.
                      (format "Value out of range for byte: %s" i))))))
        ints))


(defn klvs-from-bytes
  "Parses a byte array into a List of KLVs."
  [^bytes data]
  (KLV/bytesToList
   data
   0
   (count data)
   KLV$KeyLength/SixteenBytes
   KLV$LengthEncoding/BER))


(defn read-ber [data offset]
  ;; FIXME: Handle > 127.
  [(get data offset)
   (inc offset)])


(def item-index
  (atom
   {;; Map of name (e.g. :unix-timestamp) to item definition.
    :items-by-name {}
    ;; Map from single byte (usually?) local set key (e.g. 3) to item
    ;; definition.
    :local-set-keys {}
    ;; Map from 16-byte universal set key to item definition. We use
    ;; ByteBuffers as keys in this map because we're really working with
    ;; byte arrays underneath, but byte arrays hash based on object
    ;; identity while ByteBuffers hash based on contents (and are
    ;; cheaper than creating vecs from byte arrays).
    :universal-set-keys {}}))


(defn defitems [item-specs]
  (let [bb (fn [bs] (ByteBuffer/wrap (byte-array (ints->bytes bs))))
        index (fn [key-name desc items]
                (reduce-kv
                 (fn [m name attr]
                   (if-let [k (attr key-name)]
                     (do
                       (assert
                        (nil? (m k))
                        (str "Duplicate " desc " for item " name
                             " and item " (m k) ": " k))
                       (assoc m k attr))
                     m))
                 {}
                 items))]
    (->> item-specs
         ;; Add name to attrs
         (map (fn [[name attr]]
                [name (assoc attr :name name)]))
         ;; Convert universal key vecs to ByteBuffers.
         (map (fn [[name attr]]
                (assert (or (:us-key attr) (:ls-key attr))
                        (str "Item must have :us-key or :ls-key: " name))
                [name (if-let [us-key (:us-key attr)]
                        (assoc attr :us-key (bb us-key))
                        attr)]))
         ;; Convert types to decoding functions.
         (map (fn [[name attr]]
                (assert (not (and (:type attr) (:decoder attr)))
                        (str "Item cannot have :type and :decoder: " name))
                [name (if-let [type (:type attr)]
                        (assoc
                         attr
                         :decoder
                         (let [frame (if-let [scale (:scale attr)]
                                       (gloss/compile-frame type nil scale)
                                       (gloss/compile-frame type))]
                           #(gloss.io/decode frame % false)))
                        attr)]))
         (into {})
         (swap! item-index assoc :items-by-name))
    ;; Index local set keys.
    (swap! item-index assoc :local-set-keys
           (index :ls-key "local set key" (:items-by-name @item-index)))
    ;; Index universal set keys.
    (swap! item-index assoc :universal-set-keys
           (index :us-key "universal set key" (:items-by-name @item-index)))))


(defn scaler [src-min src-max dst-min dst-max]
  #(double
    (+ (* (/ (- % src-min)
             (- src-max src-min))
          (- dst-max dst-min))
       dst-min)))




;; Taken from
;; http://trac.osgeo.org/ossim/browser/trunk/ossimPredator/src/ossimPredatorKlvTable.cpp

(defn decode-basic-universal-dataset [^bytes data]
  (let [klvs (klvs-from-bytes data)]
    (map (fn [^KLV klv]
           (let [item-def (get-in @item-index
                                  [:universal-set-keys
                                   (ByteBuffer/wrap (.getFullKey ^KLV klv))])
                 item-name (:name item-def)]
             (if item-def
               [item-name ((:decoder item-def) (.getValue klv))]
               [(vec (.getFullKey klv)) (vec (.getValue klv))])))
         klvs)))


(defn decode-local-set-tag
  ([data]
   (decode-local-set-tag data 0))
  ([^bytes data offset]
   (let [[tag-value offset] (read-ber data offset)
         item-def (get-in @item-index [:local-set-keys tag-value])
         [len offset] (read-ber data offset)
         tag-data (byte-array len)]
     (System/arraycopy data offset tag-data 0 len)
     [(+ offset len)
      (if item-def
        [(:name item-def)
         (if-let [decoder (:decoder item-def)]
           (decoder tag-data)
           tag-data)]
        [tag-value (vec tag-data)])])))


(defn decode-uas-datalink-local-dataset
  ([data]
   (decode-uas-datalink-local-dataset data 0))
  ([data offset]
   (loop [offset offset
          values '()]
     (if (>= offset (count data))
       (reverse values)
       (let [[offset tag] (decode-local-set-tag data offset)]
         (recur
          offset
          (conj values tag)))))))


(def lat-scaler (scaler -2147483647 2147483647 -90 90))
(def lon-scaler (scaler -2147483647 2147483647 -180 180))
(def pos-delta-scaler (scaler -32767 32767 -0.075 0.075))
(def alt-scaler (scaler 0 65535 -900 19000))
(def pressure-scaler (scaler 0 65535 0 5000))
(def pitch-scaler (scaler -32767 32767 -20 20))
(def full-pitch-scaler (scaler -32767 32767 -90 90))
(def range-scaler (scaler 0 4294967295 0 5000000))


(defitems
  {:basic-universal-dataset
   {:us-key [0x06 0x0E 0x2B 0x34 0x02 0x01 0x01 0x01 0x0E 0x01 0x01 0x02 0x01 0x01 0x00 0x00]
    :decoder decode-basic-universal-dataset}
   :uas-datalink-local-dataset
   {:us-key [0x06 0x0E 0x2B 0x34 0x02 0x0B 0x01 0x01 0x0E 0x01 0x03 0x01 0x01 0x00 0x00 0x00]
    :decoder decode-uas-datalink-local-dataset}
   :checksum
   {:ls-key 1
    ;; Mapped
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x02 0x03 0x01 0x00 0x00 0x00]
    :type :uint16}
   :unix-timestamp
   {:ls-key 2
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x04 0x07 0x02 0x01 0x01 0x01 0x05 0x00 0x00]
    :type :uint64}
   :mission-id
   {:ls-key 3
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x01 0x05 0x05 0x00 0x00 0x00 0x00 0x00]
    :type (gloss/string :ascii)}
   :platform-tail-number
   {:ls-key 4
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x04 0x01 0x02 0x00 0x00 0x00]
    :type (gloss/string :ascii)}
   :platform-heading
   {:ls-key 5
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x07 0x07 0x01 0x10 0x01 0x06 0x00 0x00 0x00]
    :type :uint16
    :scale (scaler 0 65535 0 360)}
   :platform-pitch
   {:ls-key 6
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x07 0x07 0x01 0x10 0x01 0x05 0x00 0x00 0x00]
    :type :int16
    :scale pitch-scaler}
   :platform-roll
   {:ls-key 7
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x07 0x07 0x01 0x10 0x01 0x04 0x00 0x00 0x00]
    :type :int16
    :scale (scaler -32767 32767 -50 50)}
   :platform-true-airspeed
   {:ls-key 8 :type :ubyte}
   :platform-indicated-airspeed
   {:ls-key 9 :type :ubyte}
   :platform-designation
   {:ls-key 10
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x01 0x01 0x20 0x01 0x00 0x00 0x00 0x00]
    :type (gloss/string :ascii)}
   :image-source-sensor
   {:ls-key 11
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x04 0x20 0x01 0x02 0x01 0x01 0x00 0x00]
    :type (gloss/string :ascii)}
   :image-coordinate-system
   {:ls-key 12
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x01 0x01 0x00 0x00 0x00 0x00]
    :type (gloss/string :ascii)}
   :sensor-lat
   {:ls-key 13
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x02 0x04 0x02 0x00]
    :type :int32
    :scale lat-scaler}
   :sensor-lon
   {:ls-key 14
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x02 0x06 0x02 0x00]
    :type :int32
    :scale lon-scaler}
   :sensor-true-alt
   {:ls-key 15
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x02 0x01 0x02 0x02 0x00 0x00]
    :type :uint16
    :scale alt-scaler}
   :sensor-horizontal-fov
   {:ls-key 16
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x02 0x04 0x20 0x02 0x01 0x01 0x08 0x00 0x00]
    :type :uint16 :scale (scaler 0 65535 0 180)}
   :sensor-vertical-fov
   {:ls-key 17 :type :uint16 :scale (scaler 0 65535 0 180)}
   :sensor-relative-azimuth
   {:ls-key 18 :type :uint32 :scale (scaler 0 4294967295 0 360)}
   :sensor-relative-elevation
   {:ls-key 19 :type :int32 :scale (scaler -2147483647 2147483647 -180 180)}
   :sensor-relative-roll
   {:ls-key 20 :type :int32 :scale (scaler 0 4294967295 0 360)}
   :slant-range
   {:ls-key 21
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x08 0x01 0x01 0x00 0x00 0x00]
    :type :uint32
    :scale range-scaler}
   :target-width
   {:ls-key 22
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x09 0x02 0x01 0x00 0x00 0x00]
    :type :uint16
    :scale (scaler 0 65535 0 10000)}
   :frame-center-lat
   {:ls-key 23
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x02 0x01 0x03 0x02 0x00 0x00]
    :type :int32
    :scale lat-scaler}
   :frame-center-lon
   {:ls-key 24
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x02 0x01 0x03 0x04 0x00 0x00]
    :type :int32
    :scale lon-scaler}
   :frame-center-elevation
   {:ls-key 25 :type :uint16 :scale alt-scaler}
   :offset-corner-lat-point-1
   {:ls-key 26
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x07 0x01 0x00]
    :type :int16
    :scale pos-delta-scaler}
   :offset-corner-lon-point-1
   {:ls-key 27
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x0B 0x01 0x00]
    :type :int16
    :scale pos-delta-scaler}
   :offset-corner-lat-point-2
   {:ls-key 28
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x08 0x01 0x00]
    :type :int16
    :scale pos-delta-scaler}
   :offset-corner-lon-point-2
   {:ls-key 29
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x0C 0x01 0x00]
    :type :int16
    :scale pos-delta-scaler}
   :offset-corner-lat-point-3
   {:ls-key 30
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x09 0x01 0x00]
    :type :int16
    :scale pos-delta-scaler}
   :offset-corner-lon-point-3
   {:ls-key 31
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x0D 0x01 0x00]
    :type :int16
    :scale pos-delta-scaler}
   :offset-corner-lat-point-4
   {:ls-key 32
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x0A 0x01 0x00]
    :type :int16
    :scale pos-delta-scaler}
   :offset-corner-lon-point-4
   {:ls-key 33
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x0E 0x01 0x00]
    :type :int16
    :scale pos-delta-scaler}
   :icing-detected
   {:ls-key 34 :type :ubyte}
   :wind-direction
   {:ls-key 35 :type :uint16 :scale (scaler 0 65535 0 360)}
   :wind-speed
   {:ls-key 36 :type :ubyte :scale (scaler 0 255 0 100)}
   :static-pressure
   {:ls-key 37 :type :uint16 :scale pressure-scaler}
   :density-altitude
   {:ls-key 38 :type :uint16 :scale alt-scaler}
   :outside-air-temp
   {:ls-key 39 :type :byte}
   :target-location-lat
   {:ls-key 40 :type :int32 :scale lat-scaler}
   :target-location-lon
   {:ls-key 41 :type :int32 :scale lon-scaler}
   :target-location-elevation
   {:ls-key 42 :type :uint16 :scale alt-scaler}
   :target-track-gate-width
   {:ls-key 43 :type :ubyte}
   :target-track-gate-height
   {:ls-key 44 :type :ubyte}
   :target-error-estimate-ce90
   {:ls-key 45 :type :uint16}
   :target-error-estimate-le90
   {:ls-key 46 :type :uint16}
   :generic-flag-data
   {:ls-key 47 :type :ubyte}
   ;; FIXME
   :security-local-metadata-set
   {:ls-key 48
    :us-key [0x06 0x0E 0x2B 0x34 0x02 0x03 0x01 0x01 0x0E 0x01 0x03 0x03 0x02 0x00 0x00 0x00]
    :type :ubyte}
   :differential-pressure
   {:ls-key 49 :type :uint16 :scale pressure-scaler}
   :platform-aoa
   {:ls-key 50 :type :int16 :scale pitch-scaler}
   :platform-vertical-speed
   {:ls-key 51 :type :int16 :scale (scaler -32767 32767 -180 180)}
   :platform-sideslip-angle
   {:ls-key 52 :type :int16 :scale (scaler -32767 32767 -20 20)}
   :airfield-baro-pressure
   {:ls-key 53 :type :uint16 :scale pressure-scaler}
   :airfield-elevation
   {:ls-key 54 :type :uint16 :scale alt-scaler}
   :relative-humidity
   {:ls-key 55 :type :uint8 :scale (scaler 0 255 0 100)}
   :platform-ground-speed
   {:ls-key 56 :type :ubyte}
   :ground-range
   {:ls-key 57 :type :uint32 :scale range-scaler}
   :platform-fuel-remaining
   {:ls-key 58 :type :uint16 :scale (scaler 0 65535 0 10000)}
   :platform-call-sign
   {:ls-key 59 :type (gloss/string :ascii)}
   :weapon-load
   {:ls-key 60 :type :uint16}
   :weapon-fired
   {:ls-key 61 :type :uint8}
   :laser-prf-code
   {:ls-key 62 :type :uint16}
   :sensor-fov-name
   {:ls-key 63 :type :ubyte}
   :platform-magnetic-heading
   {:ls-key 64 :type :uint16 :scale (scaler 0 65535 0 360)}
   :uas-ls-version-number
   {:ls-key 65 :type :ubyte}
   ;; "TBD" in ST0601.8 spec.
   :target-location-covariance-matrix {:ls-key 66 :type :ubyte}
   :alternate-platform-lat {:ls-key 67 :type :int32 :scale lat-scaler}
   :alternate-platform-lon {:ls-key 68 :type  :int32 :scale lon-scaler}
   :alternate-platform-alt {:ls-key 69 :type :uint16 :scale alt-scaler}
   :alternate-platform-name {:ls-key 70 :type (gloss/string :ascii)}
   :alternate-platform-heading {:ls-key 71 :type :uint16 :scale (scaler 0 65535 0 360)}
   :event-start-time-utc
   {:ls-key 72
    :us-key [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x02 0x01 0x02 0x07 0x01 0x00 0x00]
    :type :uint64}
   :rvt-local-set
   {:ls-key 73
    :us-key [0x06 0x0E 0x2B 0x34 0x02 0x0B 0x01 0x01 0x0E 0x01 0x03 0x01 0x02 0x00 0x00 0x00]
    ;; FIXME
    :type :ubyte}
   :vmti-data-set
   {:ls-key 74
    :us-key [0x06 0x0E 0x2B 0x34 0x02 0x0B 0x01 0x01 0x0E 0x01 0x03 0x03 0x06 0x00 0x00 0x00]
    :type :ubyte}
   :sensor-ellipsoid-height
   {:ls-key 75
    :type :uint16
    :scale alt-scaler}
   :alternate-platform-ellipsoid-height
   {:ls-key 76
    :type :uint16
    :scale alt-scaler}
   :operational-mode
   {:ls-key 77
    :type :ubyte}
   :frame-center-height-above-ellipsoid
   {:ls-key 78
    :type :uint16
    :scale alt-scaler}
   :sensor-north-velocity
   {:ls-key 79
    :type :int16
    :scale (scaler 0 65535 -327 327)}
   :sensor-east-velocity
   {:ls-key 80
    :type :int16
    :scale (scaler 0 65535 -327 327)}
   :image-horizon-pixel-pack
   {:ls-key 81
    ;; FIXME
    :type :ubyte}
   :corner-lat-point-1
   {:ls-key 82
    :type :int32
    :scale lat-scaler}
   :corner-lon-point-1
   {:ls-key 83
    :type :int32
    :scale lon-scaler}
   :corner-lat-point-2
   {:ls-key 84
    :type :int32
    :scale lat-scaler}
   :corner-lon-point-2
   {:ls-key 85
    :type :int32
    :scale lon-scaler}
   :corner-lat-point-3
   {:ls-key 86
    :type :int32
    :scale lat-scaler}
   :corner-lon-point-3
   {:ls-key 87
    :type :int32
    :scale lon-scaler}
   :corner-lat-point-4
   {:ls-key 88
    :type :int32
    :scale lat-scaler}
   :corner-lon-point-4
   {:ls-key 89
    :type :int32
    :scale lon-scaler}
   :platform-pitch-full
   {:ls-key 90
    :type :int32
    :scale full-pitch-scaler}
   })


(def tags
  [[:klv-key-stream-id
    "stream ID",
    [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x01 0x03 0x04 0x02 0x00 0x00 0x00 0x00]],
   [:klv-key-organizational-program-number "Organizational Program Number",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x01 0x03 0x05 0x01 0x00 0x00 0x00 0x00]],
   [:klv-key-unix-timestamp "UNIX Timestamp",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x04 0x07 0x02 0x01 0x01 0x01 0x05 0x00 0x00]],
   [:klv-key-user-defined-utc-timestamp "User Defined UTC" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x02 0x01 0x01 0x01 0x01 0x00 0x00]],
   [:klv-key-user-defined-timestamp-microseconds-1970 "User Defined Timestamp Microseconds since 1970" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x02 0x01 0x01 0x01 0x05 0x00 0x00]],
   [:klv-key-video-start-date-time-utc "Video Timestamp Start Date and Time",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x02 0x01 0x02 0x01 0x01 0x00 0x00]],
   [:klv-timesystem-offset "Time System Offset From UTC" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x03 0x01 0x03 0x03 0x01 0x00 0x00 0x00]],
   [:klv-uas-datalink-local-dataset "UAS Datalink Local Data Set",[0x06 0x0E 0x2B 0x34 0x02 0x0B 0x01 0x01 0x0E 0x01 0x03 0x01 0x01 0x00 0x00 0x00]],
   [:klv-basic-universal-metadata-set "Universal Metadata Set",[0x06 0x0E 0x2B 0x34 0x02 0x01 0x01 0x01 0x0E 0x01 0x01 0x02 0x01 0x01 0x00 0x00]],
   [:klv-security-metadata-universal-set "Security metadata universal set" [0x06 0x0E 0x2B 0x34 0x02 0x01 0x01 0x01 0x02 0x08 0x02 0x00 0x00 0x00 0x00 0x00]],
   [:klv-url-string "URL String" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x01 0x02 0x01 0x01 0x00 0x00 0x00 0x00]],
   [:klv-key-security-classification-set "Security Classification Set" [0x06 0x0E 0x2B 0x34 0x02 0x01 0x01 0x01 0x02 0x08 0x02 0x00 0x00 0x00 0x00 0x00]],
   [:klv-key-byte-order "Byte Order" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x03 0x01 0x02 0x01 0x02 0x00 0x00 0x00]],
   [:klv-key-mission-number"Mission Number",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x01 0x05 0x05 0x00 0x00 0x00 0x00 0x00]],
   [:klv-key-object-country-codes "Object Country Codes" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x20 0x01 0x02 0x01 0x01 0x00]],
   [:klv-key-security-classification "Security Classification" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x02 0x08 0x02 0x01 0x00 0x00 0x00 0x00]],
   [:klv-key-security-release-instructions "Release Instructions" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x20 0x01 0x02 0x09 0x00 0x00]],
   [:klv-key-security-caveats "Caveats" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x02 0x08 0x02 0x02 0x00 0x00 0x00 0x00]],
   [:klv-key-classification-comment "Classification Comment" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x02 0x08 0x02 0x07 0x00 0x00 0x00 0x00]],
   [:klv-key-original-producer-name "Original Producer Name" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x02 0x01 0x03 0x00 0x00 0x00 0x00 0x00]],
   [:klv-key-platform-ground-speed"Platform Ground Speed",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x01 0x01 0x05 0x00 0x00 0x00]],
   [:klv-key-platform-magnetic-heading-angle"Platform Magnetic Heading Angle",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x01 0x01 0x08 0x00 0x00 0x00]],
   [:klv-key-platform-heading-angle"Platform Heading Angle",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x07 0x07 0x01 0x10 0x01 0x06 0x00 0x00 0x00]],
   [:klv-key-platform-pitch-angle"Platform Pitch Angle",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x07 0x07 0x01 0x10 0x01 0x05 0x00 0x00 0x00]],
   [:klv-key-platform-roll-angle "Platform Roll Angle",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x07 0x07 0x01 0x10 0x01 0x04 0x00 0x00 0x00]],
   [:klv-key-indicated-air-speed "Platform Indicated Air Speed",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x01 0x01 0x0B 0x00 0x00 0x00]],
   [:klv-key-platform-designation "Platform Designation",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x01 0x01 0x20 0x01 0x00 0x00 0x00 0x00]],
   [:klv-key-platform-designation2 "Platform Designation",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x01 0x01 0x21 0x01 0x00 0x00 0x00 0x00]],
   [:klv-key-image-source-sensor "Image Source Sensor",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x04 0x20 0x01 0x02 0x01 0x01 0x00 0x00]],
   [:klv-key-image-coordinate-system "Image Coordinate System",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x01 0x01 0x00 0x00 0x00 0x00]],
   [:klv-key-sensor-latitude "Sensor Latitude",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x02 0x04 0x02 0x00]],
   [:klv-key-sensor-longitude "Sensor Longitude",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x02 0x06 0x02 0x00]],
   [:klv-key-sensor-true-altitude "Sensor True Altitude",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x02 0x01 0x02 0x02 0x00 0x00]],
   [:klv-key-sensor-horizontal-fov "Sensor Horizontal Field Of View",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x02 0x04 0x20 0x02 0x01 0x01 0x08 0x00 0x00]],
   [:klv-key-sensor-vertical-fov1 "Sensor Vertical Field Of View",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x07 0x04 0x20 0x02 0x01 0x01 0x0A 0x01 0x00]],
   [:klv-key-sensor-vertical-fov2 "Sensor Vertical Field Of View",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x04 0x20 0x02 0x01 0x01 0x0A 0x01 0x00]],
   [:klv-key-slant-range "Slant Range",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x08 0x01 0x01 0x00 0x00 0x00]],
   [:klv-key-obliquity-angle "Obliquity Angle",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x10 0x01 0x03 0x00 0x00 0x00]],
   [:klv-key-angle-to-north "Angle To North" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x10 0x01 0x02 0x00 0x00 0x00]],
   [:klv-key-target-width "Target Width",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x09 0x02 0x01 0x00 0x00 0x00]],
   [:klv-key-frame-center-latitude "Frame Center Latitude",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x02 0x01 0x03 0x02 0x00 0x00]],
   [:klv-key-frame-center-longitude "Frame Center Longitude",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x02 0x01 0x03 0x04 0x00 0x00]],
   [:klv-key-frame-center-elevation "Frame Center elevation",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x06 0x07 0x01 0x02 0x03 0x10 0x00 0x00 0x00]],
   [:klv-key-corner-latitude-point-1 "Corner Latitude Point 1",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x07 0x01 0x00]],
   [:klv-key-corner-longitude-point-1 "Corner Longitude Point 1",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x0B 0x01 0x00]],
   [:klv-key-corner-latitude-point-2 "Corner Latitude Point 2",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x08 0x01 0x00]],
   [:klv-key-corner-longitude-point-2 "Corner Longitude Point 2",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x0C 0x01 0x00]],
   [:klv-key-corner-latitude-point-3 "Corner Latitude Point 3",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x09 0x01 0x00]],
   [:klv-key-corner-longitude-point-3 "Corner Longitude Point 3",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x0D 0x01 0x00]],
   [:klv-key-corner-latitude-point-4 "Corner Latitude Point 4",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x0A 0x01 0x00]],
   [:klv-key-corner-longitude-point-4 "Corner Longitude Point 4",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x03 0x07 0x01 0x02 0x01 0x03 0x0E 0x01 0x00]],
   [:klv-key-device-absolute-speed "Device Absolute Speed",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x03 0x01 0x01 0x01 0x00 0x00]],
   [:klv-key-device-absolute-heading "Device Absolute Heading",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x03 0x01 0x01 0x02 0x00 0x00]],
   [:klv-key-absolute-event-start-date "Absolute Event Start Date",[0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x02 0x01 0x02 0x07 0x01 0x00 0x00]],
   [:klv-key-sensor-roll-angle "Sensor Roll Angle" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x07 0x01 0x10 0x01 0x01 0x00 0x00 0x00]],
   [:klv-key-sensor-relative-elevation-angle "Sensor Relative Elevation Angle" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x01 0x02 0x05 0x00 0x00 0x00]],
   [:klv-key-sensor-relative-azimuth-angle "Sensor Relative Azimuth Angle" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x01 0x02 0x04 0x00 0x00 0x00]],
   [:klv-key-sensor-relative-roll-angle "Sensor Relative Roll Angle" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x01 0x02 0x06 0x00 0x00 0x00]],
   [:klv-key-uas-lds-version-number "UAS LDS Version Number" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x02 0x03 0x03 0x00 0x00 0x00]],
   [:klv-key-generic-flag-data-01 "Generic Flag Data 01" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x01 0x03 0x01 0x00 0x00 0x00]],
   [:klv-key-static-pressure "Static Pressure" [0x06 0x0E 0x2B 0x34 0x01 0x01 0x01 0x01 0x0E 0x01 0x01 0x01 0x0F 0x00 0x00 0x00]]])

(def tags-table
  (map (fn [[sym name key]]
         [sym name (byte-array (ints->bytes key))])
       tags))


(defn find-klv-signature [^bytes key]
  (loop [tags tags-table]
    (if-let [tag (first tags)]
      (if (Arrays/equals ^bytes (tag 2) key)
        tag
        (recur (rest tags)))
      nil)))


(defn -main [& args]
  (-> args
      first
      xio/binary-slurp
      decode-basic-universal-dataset
      pprint/pprint))
